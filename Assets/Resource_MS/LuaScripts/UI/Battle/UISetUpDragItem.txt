---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by liuyubao.
--- DateTime: 2022/1/19 15:05
---@class UISetUpDragItem:UIDragMoveBaseItem
local UISetUpDragItem = SimpleClassUtil:class(UIDragMoveBaseItem)

function UISetUpDragItem:initialize(transform,index,battleTeam,rect_modelRoot,endDelegate)
    UIDragMoveBaseItem.initialize(self,transform)
    self._transform = transform
    self._index = index
    ---@type BattleTeam
    self._battleTeam = battleTeam

    self._pos_model_init = Vector3_CS.zero

    self._endDelegate = endDelegate
    self._pos_target = Vector3_CS.zero
    self._rect_modelRoot = rect_modelRoot
    self._uiCamera = LC.GetUICamera()
    self:initComponent(transform)
    self:setDragEvent()
    --self:startUpdate()
end

function UISetUpDragItem:initComponent(transform)
    self._rect_root = transform:GetComponent("RectTransform")
    self._img_icon = transform:Find("m_img_top/m_img_icon"):GetComponent("Image")
    self._txt_level = transform:Find("m_img_top/m_txt_level"):GetComponent("Text")
end

function UISetUpDragItem:setData(data,type,rectPos)
    self._type = type
    self._isSelf = type == Enum.SetUpTeamEnum.TeamPos.left
    self._data = data

    -- todo 获取敌人数据 或者 此数据直接 传进来
    self._heroData = self._isSelf and HeroProxy:getHeroDataByUid(self._data.heroUid) or {}
    --Logger.ErrorTable(data)
    self:traLoad()
    --self:initPosition(rectPos)
    self:setBaseData()
    self:setActive(true)
end

function UISetUpDragItem:setActive(isActive)
    self._isActive = isActive
    self._transform.gameObject:SetActiveVirtual(isActive)
end

function UISetUpDragItem:traLoad()
    local path = BattleUtils:getHeroAssetPathByHeroId( self._data.heroId)
    BattleLoaderManager:pop(path,Enum_Battle.BattleAssetType.Model,function(model)
        -- todo 不应该在这里加 按理说应该移动到战斗内加
        BattleUtils:addComponentForModel(model)
        BattleUtils:setInitPos(self._isSelf,self._index,model,
                self._isSelf and self._battleTeam._go_left.transform or self._battleTeam._go_right.transform)
        self._go_model = model.gameObject
        self._trans_model = model.gameObject.transform
        self._pos_model_init = model.gameObject.transform.position
        self._pos_target = model.gameObject.transform.position

        self:updateTopPos()
    end)
end

function UISetUpDragItem:toTarget(vec,index)
    self._index = index
    self._pos_target = vec
end

function UISetUpDragItem:initPosition(rectPos)
    rectPos.y = rectPos.y - 50
    self._rect_root.anchoredPosition = rectPos
    self._transform:SetLocalPositionZ(0)
end

function UISetUpDragItem:setBaseData()
    self._txt_level.text = self._heroData.level or 0
end


function UISetUpDragItem:update()
    if  self._trans_model and Vector3_CS.Distance(self._trans_model.position,self._pos_target) > 0.01 then
        self._trans_model.position = Vector3_CS.Lerp( self._trans_model.position,self._pos_target,TimerScheduler.deltaTime * 6);
        -- todo 换算 头顶UI 位置
        self:updateTopPos()
    end
end

function UISetUpDragItem:updateTopPos()
    if self._trans_model and  self._uiCamera then
        local vecPos = self._trans_model.position
        local uiPos = LC.WorldPosToScreenLocalPos(self._battleTeam._roleCamera, self._uiCamera,self._rect_modelRoot,vecPos)
        self:initPosition(uiPos)
    end

end
--------------------------------------------
----------------以下内容会抽象出基类
------------------------------------------

function UISetUpDragItem:isCanDrag()
    return self._isSelf
end

function UISetUpDragItem:clickEvent()
    Logger.error("clickEvent *** 点击事件  ")
end

function UISetUpDragItem:beginEvent(eventData)
    --self._mediator:setStartDrag(self._hero:getId())
end

function UISetUpDragItem:ingEvent(eventData,vec,isSlant)
    if isSlant then
        --self._mediator:setDragPosition(vec,self._hero:getId())
        self:refreshTarget()
    end
end

function UISetUpDragItem:refreshTarget()

    local v = Vector3_CS(CS.UnityEngine.Input.mousePosition.x, CS.UnityEngine.Input.mousePosition.y)
    local ray = self._battleTeam._roleCamera:ScreenPointToRay(v)
    local point = LC.GetRayRaycastHitInfo(ray)
    self._pos_target = point
end

function UISetUpDragItem:endEvent(eventData)
    --self._mediator:setEndDrag(self._hero:getId())
    if self._endDelegate then
        self._endDelegate(self,self._pos_target,self._index)
    end
end

function UISetUpDragItem:getIsSlantDrag(eventData)
    return true
end

function UISetUpDragItem:slantDragAngle()
    return 90
end

return UISetUpDragItem
