---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by lyb.
--- DateTime: 2021/12/8 0:03
--- 叶子节点
---@class bt_ac_find_target : IAction
local bt_ac_find_target = SimpleClassUtil:class(IAction)


function bt_ac_find_target:initialize()
    IAction.initialize(self)
end

function bt_ac_find_target:initData(data)

end

---@param blackBoard BlackBoard_BattleBase
function bt_ac_find_target:doAction(blackBoard,agent)
    local result = Enum_BT.Node_ResultType.Fail
    if blackBoard._enmityIndex == 0 then
        result = Enum_BT.Node_ResultType.Fail
        blackBoard._find_target_pos = nil
    else
        --- @type BattleEntityContext
        local _entityContext = agent._entityContext
        --- @type BattleCharacter
        local _enemyEntity = _entityContext:getEnemyEntityByIndex(blackBoard._campType,blackBoard._enmityIndex)
        if _enemyEntity  and _enemyEntity:getData()._alive == true and  _enemyEntity:getData()._isCanBeSelected == true then
            local skillData = blackBoard._skillData[Enum_Battle.SkillTag.Skill_5]
            if skillData then
                local self_pos = blackBoard._position
                local place_target = blackBoard._find_target_pos
                local target =  _enemyEntity:getData()._position
                local _volume_r = blackBoard._isCloseIn and  _enemyEntity:getData()._volume_r or 0
                local attack_r = skillData._skill_r + _volume_r
                --if place_target == nil or Vector3.Distance(place_target,target) > attack_r then
                --    local normalVec = Vector3.Normalize(target - self_pos)
                --    place_target = target - (normalVec * attack_r)
                --end
                local normalVec = Vector3.Normalize(target - self_pos)
                place_target = target - (normalVec * attack_r)
                --if blackBoard._uid == 4 then
                --    Logger.error("place_target == ",place_target)
                --end
                local isHandleSuss ,tmp_pos = BattleUtils:handleTarget_place_r(place_target,nil,_entityContext,_enemyEntity,blackBoard,1)

                --if blackBoard._uid == 4 then
                --    Logger.error("isHandleSuss == ",isHandleSuss,"  tmp_pos == ",tmp_pos," place_r == ",blackBoard._place_r)
                --end

                if isHandleSuss then
                    place_target = tmp_pos
                    --local dic = Vector3.Distance(place_target,blackBoard._position)
                    --if dic < BattleConstant.Dist_r then
                    --    place_target = _enemyEntity:getData()._position
                    --end
                    blackBoard._find_target_pos = place_target
                else
                    blackBoard._find_target_pos = nil
                end
                result = Enum_BT.Node_ResultType.Success
            else
                BattleLog.error("SkillData 没有 普工技能数据 ！！！")
                blackBoard._find_target_pos = nil
                result = Enum_BT.Node_ResultType.Fail
            end
        else
            blackBoard._find_target_pos = nil
            result = Enum_BT.Node_ResultType.Fail
        end
    end
    return result
end



return bt_ac_find_target