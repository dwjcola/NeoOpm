---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by lyb.
--- DateTime: 2021/12/8 0:03
--- 叶子节点
---@class bt_ac_way_finding : IAction
local bt_ac_way_finding = SimpleClassUtil:class(IAction)


function bt_ac_way_finding:initialize()
    IAction.initialize(self)
end

function bt_ac_way_finding:initData(data)

end
---@param blackBoard BlackBoard_BattleBase
---@param agent Agent
function bt_ac_way_finding:doAction(blackBoard,agent)
    local result = Enum_BT.Node_ResultType.Fail
    if blackBoard._enmityIndex == 0 then
        result = Enum_BT.Node_ResultType.Fail
    else
        local place_target = blackBoard._find_target_pos
        --if blackBoard._uid == 4 then
        --    Logger.error(place_target)
        --end
        local self_pos = blackBoard._position
        local moveSpeed = blackBoard._moveSpeed
        local skillData = blackBoard._skillData[Enum_Battle.SkillTag.Skill_5]
        if skillData then
            local dis = Vector3.Distance(self_pos,place_target)
            local moveVec = Vector3.Normalize(place_target - self_pos) * moveSpeed
            if dis <= BattleConstant.Dist_r then
                result = Enum_BT.Node_ResultType.Success
            else
                local newPos = self_pos + moveVec
                if moveVec:Magnitude() > dis then
                    newPos = place_target
                end
                --- @type PVE_Config_Battle_Manager
                local battleManager = agent._battleManager
                local data = {uid = blackBoard._uid,newPos = newPos,time = battleManager:getSpeedInterval()}
                EventManager:Dispatch_battle(EventType.Event_Battle_Render_Move_Line,data)
                blackBoard:setValue("_position",newPos)
                result = Enum_BT.Node_ResultType.Running
            end
        else
            BattleLog.error("SkillData 没有 普工技能数据 ！！！")
            result = Enum_BT.Node_ResultType.Fail
        end
    end
    return result
end

return bt_ac_way_finding
