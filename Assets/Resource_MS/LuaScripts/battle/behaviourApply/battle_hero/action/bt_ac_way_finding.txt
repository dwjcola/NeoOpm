---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by lyb.
--- DateTime: 2021/12/8 0:03
--- 叶子节点
---@class bt_ac_way_finding : IAction
local bt_ac_way_finding = SimpleClassUtil:class(IAction)


function bt_ac_way_finding:initialize()

end

function bt_ac_way_finding:initData(data)

end
---@param blackBoard BlackBoard_BattleBase
function bt_ac_way_finding:doAction(blackBoard,agent)
    local result = Enum_BT.Node_ResultType.Fail
    if blackBoard._enmityIndex == 0 then
        result = Enum_BT.Node_ResultType.Fail
    else
        --- @type BattleEntityContext
        local _entityContext = agent._entityContext
        --- @type BattleCharacter
        local _enemyEntity = _entityContext:getEnemyEntityByIndex(blackBoard._campType,blackBoard._enmityIndex)
        if _enemyEntity == nil and _enemyEntity:getData()._alive == true and  _enemyEntity:getData()._isCanBeSelected == true then
            local self_pos = blackBoard._position
            local target =  _enemyEntity:getData()._position

            Logger.Error(self_pos)

            Logger.Error(target)

            local dis = Vector3.Distance(self_pos,target)
            if dis <= blackBoard._skillData[Enum_Battle.SkillTag.Skill_5]._skill_r then
                result = Enum_BT.Node_ResultType.Success
            else
                local moveSpeed = blackBoard._moveSpeed or 1
                local moveVec = Vector3.Normalize(target - self_pos) * moveSpeed
                local newPos = self_pos + moveVec

                --- @type PVE_Config_Battle_Manager
                local battleManager = agent._battleManager
                local data = {uid = blackBoard._uid,newPos = newPos,time = battleManager._interval}
                EventManager:Dispatch_battle(EventType.Event_Battle_Render_Move_Line,data)

                result = Enum_BT.Node_ResultType.Running
            end


        else
            result = Enum_BT.Node_ResultType.Fail
        end
    end
end

return bt_ac_way_finding