---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by lyb.
--- DateTime: 2021/12/8 1:02
---  重复执行修饰节点 Repeater 重复执行子节点 N 次
---        修饰节点_重复:
---         开始执行该节点时，将记录次数清零
---         顺序执行所有子节点(记为 1 次)，不关心节点返回结果
---         如果 执行次数 < 配置执行次数 向父节点返回 Running
---         如果 执行次数 >= 配置执行次数 向父节点返回 Success
---@class NodeDecoratorRepeat : NodeDecorator
local NodeDecoratorRepeat = SimpleClassUtil:class(NodeDecorator)

function NodeDecoratorRepeat:initialize()
    self.super:initialize(Enum_BT.Node_Type.Decorator_Repeat)
    self._runningNode = 0
    self._repeatCount = 0
    self._executeCount = 0
end

function NodeDecoratorRepeat:onEnter()
    self.super:onEnter()
    self:reStart()
end

function NodeDecoratorRepeat:onExit()
    self.super:onExit()
    self:reStart()

    for i = 1, self:getChildesCount() do
        local value = 1 << i
        if (self._runningNode & value) > 0 then
            local node = self:getChildesByIndex(i)
            node:postPosition(Enum_BT.Node_ResultType.Fail)
        end
    end
end


function NodeDecoratorRepeat:execute()
    self._executeCount = self._executeCount + 1
    local resultType = Enum_BT.Node_ResultType.Fail
    local count = #self:getChildes()
    for i = 1, count do
        local nodeBase = self:getChildesByIndex(i)

        nodeBase:prePosition()
        resultType = nodeBase:execute()
        nodeBase:postPosition(resultType)

        if resultType == Enum_BT.Node_ResultType.Running then
            self._runningNode =  self._runningNode | (1 << i)
        end
    end

    if (self._repeatCount == -1) or self._executeCount < self._repeatCount then
        resultType = Enum_BT.Node_ResultType.Running
    else
        resultType = Enum_BT.Node_ResultType.Success
    end

    return resultType
end

function NodeDecoratorRepeat:reStart()
    self._executeCount = 0
end

function NodeDecoratorRepeat:setRepeatCount(count)
    self._repeatCount = count
end

return NodeDecoratorRepeat