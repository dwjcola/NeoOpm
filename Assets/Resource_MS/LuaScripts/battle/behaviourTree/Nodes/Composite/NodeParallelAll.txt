---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by lyb.
--- DateTime: 2021/12/8 1:02
--- 并行节点(组合节点)
--- 等待所有节点结果
---并行节点：依次从头顺次遍历执行所有子节点
---       当前执行节点返回 Success、 Fail、Running 都继续执行下一个节点，分别记录返回三种结果的节点个数
---       执行完所有节点后
---       如果所有节点都返回 Success 向父节点返回 Success
---       如果所有节点都返回 Fail 或者 有一个 Fail向父节点返回 Fail
---       否则一定有节点返回了Running 向父节点返回 Running
---
--local NodeComposite = require_path("NodeComposite","battle/behaviourTree/Nodes/AbstractNode/NodeComposite")
---@class NodeParallelAll : NodeComposite
local NodeParallelAll = SimpleClassUtil:class(NodeComposite)

function NodeParallelAll:initialize()
    NodeComposite.initialize(self,Enum_BT.Node_Type.Parallel_All)

    self._runningNode = 0

end

function NodeParallelAll:onEnter()
    NodeComposite.onEnter(self)
    self._runningNode = 0
end

function NodeParallelAll:onExit()
    NodeComposite.onExit(self)
    for index, nodeChild in ipairs(self:getChildes()) do
        local value =  1 << index
        if (self._runningNode & value) > 0 then
            nodeChild:postPosition(Enum_BT.Node_ResultType.Fail)
        end
    end
end

function NodeParallelAll:execute(blackboard,agent,dt)
    self:log_enter("NodeParallelAll    Entity: ",self:getEntityId())
    local resultType = Enum_BT.Node_ResultType.Fail
    local successCount = 0
    local failCount = 0
    local list_childes = self:getChildes() or {}
    for index, nodeChild in ipairs(list_childes) do
        nodeChild:prePosition()
        resultType = nodeChild:execute(blackboard,agent,dt)
        nodeChild:postPosition(resultType)
        if resultType == Enum_BT.Node_ResultType.Fail then
            failCount = failCount + 1
        elseif resultType == Enum_BT.Node_ResultType.Success then
            successCount = successCount + 1
        else
            self._runningNode  = self._runningNode | (1 << index)
        end
    end

    if successCount >= #list_childes then
        resultType = Enum_BT.Node_ResultType.Success
    elseif failCount >= #list_childes then
        resultType = Enum_BT.Node_ResultType.Fail
    elseif (successCount + failCount) >= #list_childes and failCount > 0 then
        resultType = Enum_BT.Node_ResultType.Fail
    else
        resultType = Enum_BT.Node_ResultType.Running
    end
    self:log("NodeParallelAll    Entity: ",self:getEntityId(),    "  resultType :", resultType)
    return resultType
end
return NodeParallelAll