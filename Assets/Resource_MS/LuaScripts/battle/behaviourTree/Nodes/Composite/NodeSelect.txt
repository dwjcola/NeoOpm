---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by lyb.
--- DateTime: 2021/12/8 1:02
---  选择节点(组合节点)
---      选择节点：依次从头顺次遍历执行所有子节点 直到 返回 Success 或者 所有节点都失败
---      当前执行节点返回 Success，退出停止，向父节点
---      当前执行节点返回 Fail，退出当前节点继续执行下一个节点
---      当前执行节点返回 Running, 记录当前节点，向父节点返回 Running，下次执行直接从该节点开始
---      如果所有节点都返回Fail，执行完所有节点后向父节点返回 Fail

---@class NodeSelect : NodeComposite
local NodeSelect = SimpleClassUtil:class(NodeComposite)

function NodeSelect:initialize()
    self.super:initialize(Enum_BT.Node_Type.Select)
    ---@type NodeBase
    self._lastRunningNode = nil
end

function NodeSelect:onEnter()
    self.super:onEnter()
end

function NodeSelect:onExit()
    self.super:onExit()
    if self._lastRunningNode then
        self._lastRunningNode:postPosition(Enum_BT.Node_ResultType.Fail)
        self._lastRunningNode = nil
    end
end


function NodeSelect:execute(blackboard,contextManager)
    self:log_enter("NodeSelect    Entity: ",self:getEntityId())
    local index = 1
    if self._lastRunningNode then
        index = self._lastRunningNode:getNodeIndex()
    end
    self._lastRunningNode = nil
    local resultType = Enum_BT.Node_ResultType.Fail

    local count = #self:getChildes()
    for i = index, count do
        local nodeBase = self:getChildesByIndex(i)

        nodeBase:prePosition()
        resultType = nodeBase:execute(blackboard,contextManager)
        nodeBase:postPosition(resultType)

        if resultType == Enum_BT.Node_ResultType.Fail then
            -- nothing to do
        elseif resultType == Enum_BT.Node_ResultType.Success then
            break
        else
            self._lastRunningNode = nodeBase
            break
        end
    end
    self:log("NodeSelect   Entity: ",self:getEntityId(),    "  resultType :", resultType)
    return resultType
end


return NodeSelect